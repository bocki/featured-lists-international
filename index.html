<!doctype html>
<html>
  <head>
    <title>Featured Playlists</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type="text/css">
      #loggedin {
        display: none;
      }

      body { 
        margin: 10px 10px; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        background-color: #282828;
        color: white;
      }

      button {
        border: none;
        margin-left: 5px;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        height: 3em;
        vertical-align: middle;
        background-color: #fff;
        margin-top: 2em;
        margin-bottom: 2em;
      }

      h1 { margin: 0; margin-left: 5px; padding: 0;}

      a { color: white; text-decoration: none; }

      #featured h2 { font-size: 0.8em; margin-bottom: 0.15em; }
      #releases h2 { font-size: 0.8em; margin-bottom: 0; }
      #releases h3 { font-size: 0.7em; margin-top: 0; margin-bottom: 0.15em; font-weight: lighter;}

      .featured-grid { 
        display: flex;  
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .featured-grid div { 
        border-left: 5px solid transparent; border-right: 5px solid transparent;
        max-width: 165px;
      }

      .featured-grid div img { height: auto ; max-width: 100%; }

      @media (min-width: 800px) {
        .featured-grid div { 
          max-width: 250px;
        }
      }
      
      @media screen and (-webkit-min-device-pixel-ratio:0) { 
        select,
        textarea,
        input,
        select:focus,
        textarea:focus,
        input:focus {
          font-size: 16px !important;
        }
      }

      #countries { margin-left: 5px; margin-top: 2em;}

      #releases { margin-top: 2em; }

      .selectize-input {width: auto !important; min-width: 300px !important;}

    </style>
  </head>

  <body>
    <div class="container">
      <div id="loggedin">
        <div id="featured">
        </div>
        <div id="releases">
        </div>
        <div id="countries">
          <select id="select-country" placeholder="Select a country...">
           <option value="GB">United Kingdom / Ireland</option>
           <option value="SE">Sweden</option>
           <option value="DE">Germany / Austria</option>
           <option value="CA">Canada</option>
           <option value="US">United States</option>
           <option value="FR">France</option>
           <option value="AE">United Arab Emirates</option>
           <option value="AR">Argentina</option>
           <option value="AU">Australia / New Zealand</option>
           <option value="BH">Bahrain</option>
           <option value="BO">Bolivia</option>
           <option value="BR">Brazil</option>
           <option value="CH">Switzerland</option>
           <option value="CL">Chile</option>
           <option value="CO">Colombia</option>
           <option value="CR">Costa Rica</option>
           <option value="DE">Germany</option>
           <option value="DK">Denmark</option>
           <option value="DO">Dominican Republic</option>
           <option value="DZ">Algeria</option>
           <option value="EC">Ecuador</option>
           <option value="EG">Egypt</option>
           <option value="ES">Spain</option>
           <option value="FI">Finland</option>
           <option value="GT">Guatemala</option>
           <option value="HK">Hong Kong</option>
           <option value="HN">Honduras</option>
           <option value="ID">Indonesia</option>
           <option value="IE">Ireland</option>
           <option value="IL">Israel</option>
           <option value="IS">Iceland</option>
           <option value="IT">Italy</option>
           <option value="JO">Jordan</option>
           <option value="JP">Japan</option>
           <option value="KW">Kuwait</option>
           <option value="LB">Lebanon</option>
           <option value="MA">Morocco</option>
           <option value="MX">Mexico</option>
           <option value="MY">Malaysia</option>
           <option value="NI">Nicaragua</option>
           <option value="NL">Netherlands</option>
           <option value="NO">Norway</option>
           <option value="NZ">New Zealand</option>
           <option value="OM">Oman</option>
           <option value="PA">Panama</option>
           <option value="PE">Peru</option>
           <option value="PH">Philippines</option>
           <option value="PL">Poland</option>
           <option value="PS">Palestinian Territory</option>
           <option value="PT">Portugal</option>
           <option value="PY">Paraguay</option>
           <option value="QA">Qatar</option>
           <option value="SA">Saudi Arabia</option>
           <option value="SG">Singapore</option>
           <option value="SV">El Salvador</option>
           <option value="TH">Thailand</option>
           <option value="TN">Tunisia</option>
           <option value="TR">Turkey</option>
           <option value="TW">Taiwan</option>
           <option value="UY">Uruguay</option>
           <option value="VN">Vietnam</option>
           <option value="ZA">South Africa</option>
          </select>
        </div>
      </div>
      <div id="login">
        <h1>Featured Playlists</h1>
        <button id="login-button">Log in with Spotify</button>
      </div>
    </div>

    <script id="featured-template" type="text/x-handlebars-template">
      <h1>{{message}}</h1>
      <div class="featured-grid">
          {{#each playlists.items}}
          <div>
            <h2><a href="{{uri}}">{{name}}</a></h2>
            <a href="{{external_urls.spotify}}">
              <img src="{{images.0.url}}" />
            </a>
          </div>
          {{/each}}
      </div>
    </script>

    <script id="releases-template" type="text/x-handlebars-template">
      <h1>New Releases</h1>
      <div class="featured-grid">
          {{#each albums.items}}
          <div>
            <h2><a href="{{uri}}">{{name}}</a></h2>
            <h3>{{artists.0.name}}</h3>
            <a href="{{external_urls.spotify}}">
              <img src="{{images.0.url}}" />
            </a>
          </div>
          {{/each}}
      </div>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.default.min.css" />
    <script>
      (function() {
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        function getPlaylists(access_token, country='GB') {
          $.ajax({
              url: 'https://api.spotify.com/v1/browse/featured-playlists?country='+country,
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                console.log(response);
                featuredPlaceholder.innerHTML = featuredTemplate(response);

                $('#login h1').hide();
                $('#loggedin').show();
                document.getElementById('login-button').innerHTML = "Reload";
              }
          });
        }

        function getReleases(access_token, country='GB') {
          $.ajax({
              url: 'https://api.spotify.com/v1/browse/new-releases?limit=12&country='+country,
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                console.log(response);
                releasesPlaceholder.innerHTML = releasesTemplate(response);
              }
          });
        }

        var featuredSource = document.getElementById('featured-template').innerHTML,
            featuredTemplate = Handlebars.compile(featuredSource),
            featuredPlaceholder = document.getElementById('featured');

        var releasesSource = document.getElementById('releases-template').innerHTML,
            releasesTemplate = Handlebars.compile(releasesSource),
            releasesPlaceholder = document.getElementById('releases');

        var params = getHashParams();

        var access_token = params.access_token;

        if (access_token) {
          var country = localStorage.getItem('country');
          if(country) {
            getPlaylists(access_token, country);
            getReleases(access_token, country);
          } else {
            getPlaylists(access_token, 'GB');
            getReleases(access_token, 'GB');
          }
        } else {
              $('#login h1').show();
              $('#loggedin').hide();
        }

        document.getElementById('login-button').addEventListener('click', function() {
          var client_id = '306b3f278bff4ed89b4311853b355d35'; // Your client id
          var redirect_uri = 'https://bocki.github.io/featured-lists-international/'; // Your redirect uri

          var url = 'https://accounts.spotify.com/authorize';
          url += '?response_type=token';
          url += '&client_id=' + encodeURIComponent(client_id);
          url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
          window.location = url;
        }, false);

        $("#select-country").change(function() {
          var country=$( this ).val();
          localStorage.setItem('country', country);
          getPlaylists(access_token, country);
          getReleases(access_token, country);
        });
        var selectElement = $("#select-country").selectize();

        $("#countries > .selectize-control").click(function() {
          var selectize = selectElement[0].selectize;
          selectize.clear(true);
        });

      })();
    </script>
</html>
